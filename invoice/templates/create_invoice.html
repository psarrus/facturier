{% extends "base.html" %}

{% block content %}

<form role="form" name="form" action="{% url "create-fact" %}" method="post" enctype="multipart/form-data">

<fieldset><legend>En-tÃªte Facture</legend>
{% csrf_token %}
{{form.creation_date }}
{{form.as_p }}
</fieldset>

<fieldset>
    <legend>Lignes de la Facture</legend>
    {{ invoiceline_formset.management_form }}
    {{ invoiceline_formset.non_form_errors }}
    {% for invoiceline_form in invoiceline_formset %}
        <div class="invoiceline">
            {{ invoiceline_form.product.errors }}
            {{ invoiceline_form.product.label_tag }}
            {{ invoiceline_form.product }}
            {{ invoiceline_form.quantity.errors }}
            {{ invoiceline_form.quantity.label_tag }}
            {{ invoiceline_form.quantity }}
            {{ invoiceline_form.unit_price.errors }}
            {{ invoiceline_form.unit_price.label_tag }}
            {{ invoiceline_form.unit_price }}
        </div>
    {% endfor %}
</fieldset>

    <button type="submit" class="btn btn-default"> Valider</button>
</form>

<script type="text/javascript">
    $(function() {
        $('.invoiceline').formset({
            prefix:"{{ invoiceline_formset.prefix }}",
            deleteText : "<i class='fa fa-trash'></i>",
            addText : "<i class='fa fa-plus'></i>",
            added : dynamifyLines
        });

        function dynamifyLines() {
            $(".invoiceline select").change(function(){
                var unitPriceInput = $(this).siblings("input[id$='unit_price']")
                var quatityInput = $(this).siblings("input[id$='quantity']")
                $.getJSON( "/product/"+$(this).val()+"/json", function( data ) {
                    unitPriceInput.val(parseInt(data.product.unit_price))
                    quatityInput.val(1)

                })
            });
        }

        dynamifyLines();
    })
</script>

{% endblock %}
